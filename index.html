<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Soil Insights – Acre Insights, Holdrege NE</title>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --page: #f7f9fc;
      --card: #ffffff;
      --border: #e6ecf5;
      --shadow: rgba(15, 23, 42, 0.06);
      --text: #0f172a;
      --muted: #5b6b80;
      --ok: #33d17a;
      --hi: #ff5577;
      --lo: #4ea3ff;
      --avg: #ffbf47;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--page);
      color: var(--text);
      font-family: 'Inter', sans-serif;
    }

    .card {
      width: min(92vw, 560px);
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: 0 8px 24px var(--shadow);
      border-radius: 14px;
      padding: 24px;
      text-align: center;
    }

    .title { font-weight: 800; font-size: 26px; margin: 0 0 2px; }
    .subtitle { font-size: 16px; font-weight: 600; opacity: .9; margin: 0 0 2px; }
    .location-note { font-size: 13px; color: var(--muted); margin: 0 0 16px; }

    .divider {
      border-top: 1px solid var(--border);
      margin: 20px 0 16px;
    }

    h2 {
      font-size: 18px;
      font-weight: 800;
      margin: 4px 0 12px;
    }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
    .tile {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 12px 10px;
      text-align: center;
    }
    .label { font-size: 12px; font-weight: 700; color: var(--muted); margin-bottom: 4px; }
    .val { font-size: 28px; font-weight: 900; margin: 2px 0 0; }
    .time { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .current .val { color: var(--ok); }
    .high .val { color: var(--hi); }
    .low .val { color: var(--lo); }
    .avg .val { color: var(--avg); }

    .trend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 6px; }
    .trend-tile {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }
    .t-label { font-size: 12px; font-weight: 700; color: var(--muted); margin-bottom: 6px; }
    .t-val { font-size: 24px; font-weight: 900; line-height: 1.1; }
    .t-up { color: var(--avg); }
    .t-down { color: var(--lo); }

    /* Moisture section */
    .m-tile {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      text-align: left;
      margin-bottom: 12px;
    }
    .m-label { font-weight: 700; font-size: 13px; margin-bottom: 6px; }
    .m-bar {
      height: 14px;
      border-radius: 8px;
      background: linear-gradient(to right, #f1c232, #33d17a, #4ea3ff);
      position: relative;
    }
    .m-marker {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      border-radius: 50%;
    }
    .m-marker.current { background: #000; width: 14px; height: 14px; }
    .m-marker.avg { background: #fff; border: 2px solid #000; width: 12px; height: 12px; }
    .m-scale {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }
    .m-legend {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }
    .m-legend span {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .footnote {
      font-size: 11px;
      color: var(--muted);
      margin-top: 10px;
    }

    /* --- Compact mobile mode --- */
    @media (max-width: 420px) {
      .card{ padding:16px; }
      .title{ font-size:22px; margin-bottom:0 }
      .subtitle{ font-size:14px; margin-bottom:0 }
      .location-note{ font-size:12px; margin-bottom:10px }
      h2{ font-size:16px !important; margin-top:12px !important; margin-bottom:6px !important; }
      .grid{ gap:8px; margin-bottom:10px }
      .tile{ padding:10px 10px 8px; border-radius:10px }
      .label{ font-size:11px; margin-bottom:2px }
      .val{ font-size:24px; line-height:1; margin-top:0 }
      .time{ font-size:11px; margin-top:2px }
      .trend-grid{ gap:8px }
      .trend-tile{ padding:10px; border-radius:10px }
      .t-label{ font-size:11px; margin-bottom:4px }
      .t-val{ font-size:20px }
      .divider{ margin:12px 0 10px }
      .m-tile{ padding:12px; border-radius:10px; margin-bottom:10px }
      .m-bar{ height:10px }
      .m-marker.current{ width:12px; height:12px }
      .m-marker.avg{ width:10px; height:10px }
      .m-scale{ font-size:11px; margin-top:6px }
      .m-legend{ gap:12px; font-size:11px }
      .footnote{ display:none }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1 class="title">Soil Insights</h1>
    <div class="subtitle">Holdrege, NE</div>
    <div class="location-note">Dryland corn stubble</div>

    <div id="content">Gathering the latest data…</div>
    <div class="footnote">Data refreshes automatically every 3 hours throughout the day.</div>
  </div>

  <script>
    (async () => {
      const loggerName = "25x4gcityw";
      const tz = "America/Chicago";
      const bust = Date.now();

      const tempUrl = `/.netlify/functions/soil-temp?name=${loggerName}&tz=${encodeURIComponent(tz)}&days=30&_=${bust}`;
      const moistUrl = `/.netlify/functions/soil-moisture?name=${loggerName}&depths=6,22&_=${bust}`;

      const toF = c => Math.round((c * 9/5 + 32) * 10) / 10;
      const deltaToF = dc => Math.round((dc * 9/5) * 10) / 10;
      const signed = n => (n > 0 ? `+${n}` : `${n}`);

      try {
        const [tempRes, moistRes] = await Promise.all([fetch(tempUrl), fetch(moistUrl)]);
        const [temp, moist] = await Promise.all([tempRes.json(), moistRes.json()]);

        const trendTile = (label, deltaC) => {
          if (deltaC === null || deltaC === undefined)
            return `<div class="trend-tile"><div class="t-label">${label}</div><div class="t-val">—</div></div>`;
          const dF = deltaToF(deltaC);
          const cls = dF >= 0 ? "t-up" : "t-down";
          return `<div class="trend-tile"><div class="t-label">${label}</div><div class="t-val ${cls}">${signed(dF.toFixed(1))}°</div></div>`;
        };

        const moistureBar = (depthLabel, current, avg, low, high) => {
          const pct = v => ((v - low) / (high - low)) * 100;
          const curPos = Math.min(100, Math.max(0, pct(current)));
          const avgPos = Math.min(100, Math.max(0, pct(avg)));

          return `
            <div class="m-tile">
              <div class="m-label">${depthLabel} soil moisture</div>
              <div class="m-bar">
                <div class="m-marker current" style="left:${curPos}%"></div>
                <div class="m-marker avg" style="left:${avgPos}%"></div>
              </div>
              <div class="m-scale"><span>Dry</span><span>Wet</span></div>
              <div class="m-legend">
                <span><div class="m-marker current"></div> Current</span>
                <span><div class="m-marker avg"></div> 30-day avg</span>
              </div>
            </div>
          `;
        };

        document.getElementById("content").innerHTML = `
          <h2>Temperature</h2>
          <div class="grid">
            <div class="tile current"><div class="label">Current</div><div class="val">${toF(temp.current.value)}°F</div><div class="time">${temp.current.time}</div></div>
            <div class="tile avg"><div class="label">Average (today)</div><div class="val">${toF(temp.avg)}°F</div><div class="time">${temp.count} readings</div></div>
          </div>
          <div class="grid">
            <div class="tile high"><div class="label">High</div><div class="val">${toF(temp.high.value)}°F</div><div class="time">${temp.high.time}</div></div>
            <div class="tile low"><div class="label">Low</div><div class="val">${toF(temp.low.value)}°F</div><div class="time">${temp.low.time}</div></div>
          </div>
          <div class="trend-grid">
            ${trendTile("7-day trend", temp.trend7d?.delta)}
            ${trendTile("30-day trend", temp.trend30d?.delta)}
          </div>

          <div class="divider"></div>
          <h2>Moisture</h2>
          ${moist.depths.map(d =>
            moistureBar(
              `${d.depthIn}″`,
              d.vwc,
              d.avg30,
              d.depthIn === 6 ? 20 : 48,
              d.depthIn === 6 ? 47 : 55
            )
          ).join("")}
        `;
      } catch (e) {
        document.getElementById("content").textContent = "Fetch error: " + e.message;
      }
    })();
  </script>
</body>
</html>